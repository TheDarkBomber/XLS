#include io.xlh

#include syscalls.xlh

#include malloc.xlh

// LANGUAGE FIXME: Problems with include directives being directly on the next line after another.

// TODO: Add flags.
impl fopen(byte* path) : fhandle* {
	fhandle* file = malloc(sizeof fhandle);
	file.fd = OPEN(path, 2, 2);
	file.mode = 2;
	file.base = malloc(4096);
	// LANGUAGE FIXME: Very bad problems with fields, hence the weird redundant
	// X and Y variables.
	byte% X;
	byte% Y;
	if (file.mode == 0) {
		X = file.base;
		setcountof(X, 4096);
	} else if (file.mode == 1) {
		Y = file.base;
		setcountof(Y, 4096);
	} else {
		X = file.base;
		Y = file.base + 2048;
		setcountof(X, 2048);
		setcountof(Y, 2048);
	};
	file.rbuffer = X;
	file.wbuffer = Y;
	file.open? = 1;
	file.ri = 0;
	file.wi = 0;
	file;
}

impl fclose(fhandle* file) : dword {
	fflush(file);
	FSYNC(file.fd);
	CLOSE(file.fd);
	free(file.base);
	free(file);
	0;
}

impl fwrite(fhandle* file, byte% text) : dword {
	dword i = 0;
	byte% B = file.wbuffer;
	while (i < (countof text)) {
		if (file.wi == (countof file.wbuffer)) fflush(file);
		B[file.wi] = text[i];
		file.wi = file.wi + 1;
		if (B[file.wi - 1] == '\n') fflush(file);
		i = i + 1;
	};
	return i;
}

impl fflush(fhandle* file) : dword {
	dword x = WRITE(file.fd, file.wbuffer, file.wi);
	file.wi = 0;
	return x;
}
